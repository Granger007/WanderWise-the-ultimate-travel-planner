{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <h3 class="mb-4">üß≠ Admin Panel ‚Äî {{ table_name }}</h3>

  <!-- ‚úÖ Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ msg }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- ‚úÖ Table Data -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">üìã Records (showing up to 500)</h5>
    </div>
    <div class="card-body p-0">
      {% if rows %}
      <div class="table-responsive">
        <table class="table table-striped mb-0">
          <thead class="table-light">
            <tr>
              {% for k in rows[0].keys() %}
                <th>{{ k }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr>
              {% for v in r.values() %}
                <td>{{ v }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="p-3 text-muted">No records found in {{ table_name }}.</div>
      {% endif %}
    </div>
  </div>

  {% if triggers and triggers|length > 0 %}
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-warning">
      <h5 class="mb-0">‚öôÔ∏è Automation rules affecting <code>{{ table_name }}</code></h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>When</th>
              <th>On</th>
              <th>Name</th>
              <th>Logic</th>
            </tr>
          </thead>
          <tbody>
            {% for t in triggers %}
            <tr>
              <td>{{ t.ACTION_TIMING }} {{ t.EVENT_MANIPULATION }}</td>
              <td><code>{{ t.EVENT_OBJECT_TABLE }}</code></td>
              <td class="fw-semibold">{{ t.TRIGGER_NAME }}</td>
              <td style="max-width: 520px;">
                <details>
                  <summary class="text-primary" style="cursor:pointer">View logic</summary>
                  <pre class="mb-0 small">{{ t.ACTION_STATEMENT }}</pre>
                </details>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ‚úÖ Hide Insert/Delete for USERS, TRIP, or Complex Queries -->
  {% if table_name not in [
  'USERS', 
  'TRIP', 
  'Users Who Spent Above Average', 
  'Hotel Rankings by Location', 
  'Total Spending by User', 
  'Locations with Most Activities', 
  'Trips with Above-Average Flights'
] %}

  <!-- ‚úÖ Insert Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">‚ûï Insert New Row</h5>
    </div>
    <div class="card-body">
      <form method="post">
        <input type="hidden" name="action" value="insert"/>
        <div class="row">
          {% for f in fields %}
            <div class="col-md-4 mb-3">
              <label class="form-label">{{ f }}</label>
              <input class="form-control" name="{{ f }}" placeholder="Enter {{ f }}">
            </div>
          {% endfor %}
        </div>
        <button class="btn btn-success mt-2">Insert</button>
      </form>
    </div>
  </div>

  <!-- ‚úÖ Delete Section -->
  <div class="card shadow-sm">
    <div class="card-header bg-danger text-white">
      <h5 class="mb-0">üóëÔ∏è Delete Row</h5>
    </div>
    <div class="card-body">
      <form method="post" class="row g-3">
        <input type="hidden" name="action" value="delete"/>
        <div class="col-md-4">
          <input name="pk" class="form-control" placeholder="Enter Primary Key (e.g. trip_id)">
        </div>
        <div class="col-md-3">
          <button class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>

  {% else %}
  <div class="alert alert-info mt-4">
    <strong>Note:</strong> Insert and delete operations are disabled for 
    the <code>{{ table_name }}</code> view for data safety.
  </div>
  {% endif %}
</div>
{% endblock %}
